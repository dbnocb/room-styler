require('dotenv').config();\n\nconst express = require('express');\nconst multer = require('multer');\nconst cors = require('cors');\nconst helmet = require('helmet');\nconst compression = require('compression');\nconst rateLimit = require('express-rate-limit');\nconst axios = require('axios');\n\nconst app = express();\nconst PORT = process.env.PORT || 3001;\n\n// Security\napp.use(helmet());\napp.use(compression());\n\n// CORS\napp.use(cors({\n  origin: process.env.FRONTEND_URL || ['http://localhost:3000', 'https://*.vercel.app'],\n  credentials: true\n}));\n\n// Rate limiting\napp.use('/generate', rateLimit({\n  windowMs: 15 * 60 * 1000,\n  max: 10,\n  standardHeaders: true,\n  legacyHeaders: false,\n}));\n\n// Parsers\napp.use(express.json({ limit: '50mb' }));\napp.use(express.urlencoded({ extended: true, limit: '50mb' }));\n\n// Multer\nconst upload = multer({\n  storage: multer.memoryStorage(),\n  limits: { fileSize: 10 * 1024 * 1024 },\n  fileFilter: (req, file, cb) => {\n    if (file.mimetype.startsWith('image/')) cb(null, true);\n    else cb(new Error('Only images'), false);\n  }\n});\n\napp.get('/health', (req, res) => res.json({ status: 'ok', version: 'v2' }));\n\napp.post('/generate', upload.single('image'), async (req, res) => {\n  try {\n    if (!req.file) return res.status(400).json({ error: 'Image required' });\n    const prompt = req.body.prompt;\n    if (!prompt) return res.status(400).json({ error: 'Prompt required' });\n\n    const imageBase64 = req.file.buffer.toString('base64');\n    const apiKey = process.env.XAI_API_KEY;\n    if (!apiKey) return res.status(500).json({ error: 'API key missing' });\n\n    const xaiRes = await axios.post('https://api.x.ai/v1/images/generations', {\n      model: 'image.sample',\n      prompt,\n      image: `data:image/jpeg;base64,${imageBase64}`,\n      n: 1,\n      size: '1024x1024',\n      response_format: 'b64_json',\n      strength: 0.75\n    }, {\n      headers: {\n        Authorization: `Bearer ${apiKey}`,\n        'Content-Type': 'application/json'\n      },\n      timeout: 120000\n    });\n\n    const genImage = xaiRes.data.data[0].b64_json;\n    res.json({ image: genImage });\n  } catch (err) {\n    console.error(err.response?.data || err.message);\n    res.status(500).json({ error: err.response?.data?.error?.message || err.message });\n  }\n});\n\napp.listen(PORT, '0.0.0.0', () => console.log(`Backend v2 on port ${PORT}`));\n