import { useState, useRef, useCallback, useEffect } from 'react';\n\nconst App = () => {\n  const [history, setHistory] = useState([]);\n  const [currentImage, setCurrentImage] = useState(null);\n  const [prompt, setPrompt] = useState('');\n  const [isCameraActive, setIsCameraActive] = useState(false);\n  const [generating, setGenerating] = useState(false);\n  const [error, setError] = useState('');\n\n  const videoRef = useRef(null);\n  const canvasRef = useRef(null);\n  const fileInputRef = useRef(null);\n\n  const startCamera = useCallback(async () => {\n    try {\n      setError('');\n      const stream = await navigator.mediaDevices.getUserMedia({\n        video: { facingMode: 'environment', width: { ideal: 1280 }, height: { ideal: 720 } }\n      });\n      if (videoRef.current) videoRef.current.srcObject = stream;\n      setIsCameraActive(true);\n    } catch (err) {\n      setError('Camera access denied. Use upload.');\n    }\n  }, []);\n\n  const capturePhoto = useCallback(() => {\n    if (!videoRef.current || !canvasRef.current) return;\n    const video = videoRef.current;\n    const canvas = canvasRef.current;\n    canvas.width = video.videoWidth || 640;\n    canvas.height = video.videoHeight || 480;\n    canvas.getContext('2d').drawImage(video, 0, 0);\n    const dataUrl = canvas.toDataURL('image/jpeg', 0.85);\n    setCurrentImage(dataUrl);\n    setIsCameraActive(false);\n    video.srcObject.getTracks().forEach(track =&gt; track.stop());\n  }, []);\n\n  const handleUpload = useCallback((e) =&gt; {\n    const file = e.target.files?.[0];\n    if (file &amp;&amp; file.type.startsWith('image/')) {\n      const reader = new FileReader();\n      reader.onload = (ev) =&gt; setCurrentImage(ev.target.result);\n      reader.readAsDataURL(file);\n      setError('');\n    }\n  }, []);\n\n  const generateStyle = useCallback(async () =&gt; {\n    if (!currentImage || !prompt.trim()) {\n      setError('Need image and prompt');\n      return;\n    }\n    setGenerating(true);\n    setError('');\n    try {\n      const base64Data = currentImage.split(',')[1];\n      const byteChars = atob(base64Data);\n      const byteNums = new Array(byteChars.length);\n      for (let i = 0; i &lt; byteChars.length; i++) {\n        byteNums[i] = byteChars.charCodeAt(i);\n      }\n      const byteArray = new Uint8Array(byteNums);\n      const blob = new Blob([byteArray], { type: 'image/jpeg' });\n      const formData = new FormData();\n      formData.append('image', blob, 'room.jpg');\n      formData.append('prompt', prompt.trim());\n      const response = await fetch('/api/generate', { method: 'POST', body: formData });\n      if (!response.ok) throw new Error(await response.text());\n      const data = await response.json();\n      setHistory(prev =&gt; [...prev, { role: 'user', content: prompt.trim() }, { role: 'assistant', image: `data:image/png;base64,${data.image}` }]);\n      setCurrentImage(`data:image/png;base64,${data.image}`);\n      setPrompt('');\n    } catch (err) {\n      setError(err.message);\n    } finally {\n      setGenerating(false);\n    }\n  }, [currentImage, prompt]);\n\n  const clearImage = useCallback(() =&gt; {\n    setCurrentImage(null);\n    setHistory([]);\n    setPrompt('');\n    if (videoRef.current?.srcObject) videoRef.current.srcObject.getTracks().forEach(track =&gt; track.stop());\n  }, []);\n\n  useEffect(() =&gt; {\n    return () =&gt; {\n      if (videoRef.current?.srcObject) videoRef.current.srcObject.getTracks().forEach(track =&gt; track.stop());\n    };\n  }, []);\n\n  return (\n    &lt;&gt;\n      {error &amp;&amp; (\n        &lt;div className=&quot;bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4 mx-2&quot;&gt;\n          {error}\n        &lt;/div&gt;\n      )}\n      &lt;div className=&quot;min-h-screen flex flex-col p-2 md:p-4 bg-gradient-to-br from-slate-50 via-blue-50 to-indigo-100&quot;&gt;\n        &lt;header className=&quot;text-center py-6&quot;&gt;\n          &lt;h1 className=&quot;text-3xl md:text-4xl font-bold bg-gradient-to-r from-blue-600 via-purple-600 to-indigo-600 bg-clip-text text-transparent drop-shadow-lg&quot;&gt;\n            üé® Room Styler v2\n          &lt;/h1&gt;\n          &lt;p className=&quot;text-sm text-gray-600 mt-2&quot;&gt;AI-powered room restyling&lt;/p&gt;\n        &lt;/header&gt;\n        &lt;div className=&quot;flex-1 flex flex-col max-w-4xl mx-auto w-full gap-4&quot;&gt;\n          {currentImage ? (\n            &lt;&gt;\n              &lt;div className=&quot;flex flex-col items-center mb-6&quot;&gt;\n                &lt;img src={currentImage} alt=&quot;Current&quot; className=&quot;w-full max-w-lg h-64 object-cover rounded-3xl shadow-2xl border-8 border-white/50&quot; /&gt;\n                &lt;button onClick={clearImage} className=&quot;mt-3 px-6 py-2 bg-gray-200 hover:bg-gray-300 rounded-xl font-medium transition-all&quot;&gt;\n                  New Photo\n                &lt;/button&gt;\n              &lt;/div&gt;\n              &lt;div className=&quot;flex-1 min-h-0 overflow-y-auto p-4 bg-white/60 backdrop-blur-md rounded-3xl shadow-2xl&quot;&gt;\n                {history.length === 0 ? (\n                  &lt;p className=&quot;text-center text-gray-500 py-12 text-lg&quot;&gt;Describe a style to begin...&lt;/p&gt;\n                ) : (\n                  history.map((msg, idx) =&gt; (\n                    &lt;div key={idx} className={`mb-6 flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`}&gt;\n                      {msg.role === 'user' ? (\n                        &lt;div className=&quot;max-w-xs p-3 bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-2xl shadow-lg&quot;&gt;\n                          {msg.content}\n                        &lt;/div&gt;\n                      ) : (\n                        &lt;img src={msg.image} alt=&quot;Styled&quot; className=&quot;max-w-md h-52 rounded-2xl shadow-2xl object-cover&quot; /&gt;\n                      )}\n                    &lt;/div&gt;\n                  ))\n                )}\n              &lt;/div&gt;\n            &lt;/&gt;\n          ) : (\n            &lt;div className=&quot;flex-1 flex flex-col items-center justify-center gap-8&quot;&gt;\n              &lt;div className=&quot;text-center&quot;&gt;\n                &lt;div className=&quot;w-24 h-24 bg-blue-400/20 backdrop-blur-sm rounded-3xl flex items-center justify-center mx-auto mb-4 shadow-2xl border-4 border-blue-200&quot;&gt;\n                  &lt;span className=&quot;text-4xl&quot;&gt;üè†&lt;/span&gt;\n                &lt;/div&gt;\n                &lt;h2 className=&quot;text-2xl font-bold text-gray-800&quot;&gt;Upload your room photo&lt;/h2&gt;\n              &lt;/div&gt;\n              {isCameraActive ? (\n                &lt;&gt;\n                  &lt;video ref={videoRef} className=&quot;w-full max-w-lg h-64 object-cover rounded-3xl shadow-2xl&quot; playsInline /&gt;\n                  &lt;div className=&quot;flex gap-4 w-full max-w-lg&quot;&gt;\n                    &lt;button onClick={capturePhoto} className=&quot;flex-1 bg-emerald-500 hover:bg-emerald-600 text-white py-4 rounded-2xl font-bold shadow-xl transition-all&quot;&gt;\n                      Capture\n                    &lt;/button&gt;\n                    &lt;button onClick={() =&gt; {\n                      if (videoRef.current?.srcObject) videoRef.current.srcObject.getTracks().forEach(t =&gt; t.stop());\n                      setIsCameraActive(false);\n                    }} className=&quot;px-8 py-4 bg-gray-300 hover:bg-gray-400 rounded-2xl font-bold shadow&quot;&gt;\n                      Cancel\n                    &lt;/button&gt;\n                  &lt;/div&gt;\n                &lt;/&gt;\n              ) : (\n                &lt;div className=&quot;flex flex-col gap-4 w-full max-w-lg&quot;&gt;\n                  &lt;button \n                    onClick={startCamera}\n                    className=&quot;bg-gradient-to-r from-blue-500 to-indigo-600 hover:from-blue-600 hover:to-indigo-700 text-white py-5 px-8 rounded-3xl font-bold text-lg shadow-2xl transition-all flex items-center justify-center gap-2&quot;\n                  &gt;\n                    üì± Camera\n                  &lt;/button&gt;\n                  &lt;label className=&quot;bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600 text-white py-5 px-8 rounded-3xl font-bold text-lg shadow-2xl transition-all cursor-pointer flex items-center justify-center gap-2&quot;&gt;\n                    üñºÔ∏è Upload Photo\n                    &lt;input ref={fileInputRef} type=&quot;file&quot; accept=&quot;image/*&quot; onChange={handleUpload} className=&quot;hidden&quot; /&gt;\n                  &lt;/label&gt;\n                &lt;/div&gt;\n              )}\n              &lt;canvas ref={canvasRef} className=&quot;hidden&quot; /&gt;\n            &lt;/div&gt;\n          )}\n          {currentImage &amp;&amp; (\n            &lt;div className=&quot;mt-4 p-4 bg-white/80 backdrop-blur-md rounded-3xl shadow-2xl border border-white/50&quot;&gt;\n              &lt;div className=&quot;flex gap-3&quot;&gt;\n                &lt;textarea\n                  value={prompt}\n                  onChange={(e) =&gt; setPrompt(e.target.value)}\n                  placeholder=&quot;e.g. cyberpunk neon, cozy Scandinavian, luxurious modern...&quot;\n                  className=&quot;flex-1 p-4 border border-gray-300 rounded-2xl resize-none focus:ring-4 focus:ring-blue-200 focus:border-blue-500 min-h-[100px] font-medium&quot;\n                  disabled={generating}\n                /&gt;\n                &lt;button\n                  onClick={generateStyle}\n                  disabled={generating || !prompt.trim()}\n                  className=&quot;bg-gradient-to-r from-emerald-500 to-teal-500 hover:from-emerald-600 hover:to-teal-600 text-white px-8 py-5 rounded-2xl font-bold text-lg shadow-2xl transition-all disabled:opacity-50 whitespace-nowrap flex items-center gap-2&quot;\n                &gt;\n                  {generating ? (\n                    &lt;&gt;\n                      &lt;div className=&quot;w-6 h-6 border-2 border-white border-t-transparent rounded-full animate-spin&quot; /&gt;\n                      AI Styling...\n                    &lt;/&gt;\n                  ) : (\n                    &lt;&gt;\n                      üé® Style Room\n                    &lt;/&gt;\n                  )}\n                &lt;/button&gt;\n              &lt;/div&gt;\n            &lt;/div&gt;\n          )}\n        &lt;/div&gt;\n      &lt;/div&gt;\n    &lt;/&gt;\n  );\n};\n\nexport default App;\n